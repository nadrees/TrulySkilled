@model Guid

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Tic-Tac-Toe";
}

@section styles {
    <style type="text/css">
        #gameBoard {
            margin-left: auto;
            margin-right: auto;
            text-align: center;
        }
    </style>
}

@section scripts {
    @Scripts.Render("~/bundles/TicTacToeBundle")
    <script type="text/javascript" src="~/signalr/hubs"></script>
    <script type="text/javascript">
        var gameId = "@Model";
        var username = "@User.Identity.Name";

        function viewModel() {
            var self = this;

            self.gameHasStarted = ko.observable(false);

            // info message
            self.infoMessage = ko.observable();

            // game info
            self.youInfo = ko.observable();
        }

        var hub = $.connection.ticTacToeGameHub;
        hub.client.setAwaitingPlayers = function (players) {
            // called when a player arives in the lobby
            var message = "Waiting for players ";
            for (i = 0; i < players.length; i++) {
                message += players[i];
                if (i != players.length - 1) {
                    message += ",";
                }
            }
            message += " to arrive.";

            vm.infoMessage(message);
        };
        hub.client.beginGame = function(playersInfo) {
            // called when game should be starting
            var youInfoMessage = "You are ";
            for (i = 0; i < playersInfo.length; i++) {
                var playerInfo = playersInfo[i];
                if (playerInfo.Player == username) {
                    youInfoMessage += playerInfo.Symbol;
                    break;
                }
            }
            youInfoMessage += "'s. Player order is: ";
            for (i = 0; i < playersInfo.length; i++) {
                youInfoMessage += playersInfo[i].Player;
                if (i != playersInfo.length - 1) {
                    youInfoMessage += ", ";
                }
            }
            vm.youInfo(youInfoMessage);

            vm.infoMessage(null);
            vm.gameHasStarted(true);
        };

        var vm = new viewModel();
        window.chat.init(vm, hub);
        window.board.init("gameBoard", 250, 250);
        ko.applyBindings(vm);

        $.connection.hub.start().done(function () {
            window.chat.start('tic-tac-toe-' + gameId);
            hub.server.userArrived(gameId);
        });
    </script>
}

<div class="row-fluid" data-bind="visible: !gameHasStarted()">
    @Html.ActionLink("Return to lobby", "Index")
</div>
<div class="row-fluid" data-bind="visible: infoMessage() != null && infoMessage().length > 0">
    <div class="alert alert-info span12">
        <span data-bind="text: infoMessage"></span>
    </div>
</div>
<div class="row-fluid" data-bind="visible: youInfo() != null">
    <div class="alert alert-info span12">
        <span data-bind="text: youInfo"></span>
        <button type="button" class="close" data-dismiss="alert">&times;</button>
    </div>
</div>
<div class="row-fluid" data-bind="visible: gameHasStarted">
    <div id="gameBoard"></div>
</div>

@Html.Partial("_Chat")